<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ChargeMatter - Local Preview</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
        --color-bg: #f5f6f8;
        --color-surface: #ffffff;
        --color-text: #111827;
        --color-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-primary: #f15a22;
        --color-primary-dark: #d9480f;
        --color-primary-soft: #fff1e8;
        --color-primary-rgb: 241, 90, 34;
        --color-danger: #dc2626;
        --color-danger-soft: #fef2f2;
        --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.08);
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 10px;
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --tap-target: 44px;
        --bottom-nav-height: 60px;
        --status-free-bg: #ecfdf3;
        --status-free-text: #027a48;
        --status-in_use-bg: #eef4ff;
        --status-in_use-text: #3538cd;
        --status-reserved-bg: #f4f3ff;
        --status-reserved-text: #5925dc;
        --status-overdue-bg: #fef3f2;
        --status-overdue-text: #b42318;
        --status-overdue-border: #fecdca;
        --status-reserved-border: #d9d6fe;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
      }

      .app {
        max-width: 1100px;
        margin: var(--space-4) auto var(--space-6);
        padding: 0 var(--space-4) calc(var(--bottom-nav-height) + 96px + env(safe-area-inset-bottom));
      }

      .header {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
      }

      .title {
        font-size: 24px;
        font-weight: 700;
      }

      .subtitle {
        margin-top: var(--space-1);
        color: var(--color-muted);
        font-size: 13px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-2);
        flex-wrap: wrap;
        width: 100%;
      }

      .mode-tabs {
        display: none;
        gap: var(--space-2);
      }

      .mode-tab {
        border: 1px solid var(--color-border);
        background: #f8fafc;
        color: #2f3745;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        min-height: var(--tap-target);
      }

      .mode-tab.active {
        background: #111827;
        color: #ffffff;
        border-color: #111827;
      }

      .user-meta {
        font-size: 12px;
        color: var(--color-muted);
        max-width: 70%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .notice {
        min-height: 0;
        margin-bottom: var(--space-3);
        font-size: 13px;
        color: var(--color-danger);
      }

      .notice.notice--active {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        background: var(--color-danger-soft);
        border: 1px solid #fecaca;
      }

      .summary {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
        overflow-x: auto;
        padding-bottom: var(--space-1);
      }

      .summary.is-hidden {
        display: none;
      }

      .summary-item {
        min-width: 92px;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 2px;
        font-size: 12px;
      }

      .summary-item strong {
        font-size: 18px;
      }

      .summary-item.status-free {
        background: var(--status-free-bg);
        color: var(--status-free-text);
        border-color: #b7ebd0;
      }

      .summary-item.status-in_use {
        background: var(--status-in_use-bg);
        color: var(--status-in_use-text);
        border-color: #d3dafe;
      }

      .summary-item.status-reserved {
        background: var(--status-reserved-bg);
        color: var(--status-reserved-text);
        border-color: var(--status-reserved-border);
      }

      .summary-item.status-overdue {
        background: var(--status-overdue-bg);
        color: var(--status-overdue-text);
        border-color: var(--status-overdue-border);
      }

      .board {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }

      .card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        cursor: pointer;
      }

      .card.selected {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.2), var(--shadow-soft);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-2);
      }

      .card-header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-title {
        font-weight: 600;
        font-size: 16px;
      }

      .status-pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .status-free .status-pill {
        background: var(--status-free-bg);
        color: var(--status-free-text);
      }

      .status-in_use .status-pill {
        background: var(--status-in_use-bg);
        color: var(--status-in_use-text);
      }

      .status-overdue .status-pill {
        background: var(--status-overdue-bg);
        color: var(--status-overdue-text);
      }

      .status-reserved .status-pill {
        background: var(--status-reserved-bg);
        color: var(--status-reserved-text);
      }

      .status-overdue {
        border-color: var(--status-overdue-border);
      }

      .status-reserved {
        border-color: var(--status-reserved-border);
      }

      .card-body {
        display: grid;
        gap: var(--space-2);
        font-size: 13px;
        color: #2f3745;
      }

      .card-hint {
        font-size: 12px;
        color: var(--color-muted);
      }

      .info-row {
        display: grid;
        gap: 2px;
      }

      .info-row.secondary {
        display: none;
      }

      .card.selected .info-row.secondary {
        display: grid;
      }

      .card-body span.label {
        color: var(--color-muted);
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 2px;
      }

      .countdown {
        font-size: 16px;
        font-weight: 600;
      }

      .card-actions {
        display: none;
        flex-direction: column;
        gap: var(--space-2);
      }

      .card-actions .btn {
        width: 100%;
      }

      .primary-action {
        font-size: 14px;
        padding: 10px 14px;
      }

      .menu-trigger {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--color-muted);
      }

      .menu {
        position: relative;
      }

      .menu-list {
        position: absolute;
        right: 0;
        top: 24px;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        box-shadow: 0 8px 20px rgba(31, 36, 48, 0.12);
        min-width: 140px;
        padding: 6px;
        display: none;
        z-index: 5;
      }

      .menu-list.active {
        display: grid;
        gap: 6px;
      }

      .menu-item {
        padding: 8px;
        border-radius: 8px;
        font-size: 13px;
        background: #f8fafc;
        border: none;
        cursor: pointer;
      }

      .btn {
        border: none;
        background: var(--color-primary);
        color: #fff;
        padding: 10px 14px;
        border-radius: var(--radius-md);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        min-height: var(--tap-target);
      }

      .btn.secondary {
        background: #111827;
      }

      .btn.ghost {
        background: transparent;
        color: #2f3745;
        border: 1px solid var(--color-border);
      }

      .btn.warn {
        background: var(--color-danger);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .footer {
        margin-top: var(--space-5);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
        font-size: 12px;
        color: var(--color-muted);
      }

      .mode {
        display: none;
      }

      .mode.active {
        display: block;
      }

      .reservations {
        margin-top: var(--space-5);
        padding: var(--space-4);
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-soft);
      }

      .section-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
      }

      .section-title {
        font-size: 17px;
        font-weight: 600;
      }

      .section-subtitle {
        margin-top: var(--space-1);
        font-size: 12px;
        color: var(--color-muted);
      }

      .section-meta {
        font-size: 12px;
        color: var(--color-muted);
      }

      .reservation-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      .slots-group {
        margin-bottom: 20px;
      }

      .slots-group-title {
        font-size: 14px;
        font-weight: 600;
        color: #384150;
        margin-bottom: 8px;
      }

      .slot-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-2);
        align-items: center;
        padding: var(--space-3);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        margin-bottom: var(--space-2);
        font-size: 13px;
        background: var(--color-surface);
        cursor: pointer;
      }

      .slot-row .btn {
        display: none;
      }

      .slot-row.selected {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.15);
      }

      .edit-banner {
        display: none;
        background: #fef9c3;
        border: 1px solid #fde68a;
        color: #854d0e;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: 13px;
        margin-bottom: var(--space-3);
        align-items: center;
        justify-content: space-between;
        gap: var(--space-2);
      }

      .edit-banner.active {
        display: flex;
      }

      .slot-meta {
        display: grid;
        gap: 4px;
      }

      .reservation-form,
      .reservation-list {
        display: grid;
        gap: 12px;
      }

      .field label {
        display: block;
        font-size: 12px;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 6px;
      }

      .field input,
      .field select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #d0d5dd;
        font-size: 14px;
      }

      .form-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .list-title {
        font-size: 14px;
        font-weight: 600;
      }

      .reservation-item {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-3);
        display: grid;
        gap: var(--space-1);
        font-size: 13px;
      }

      .reservation-item.highlight {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      }

      .reservation-item strong {
        font-size: 14px;
      }

      .reservation-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      @media (min-width: 900px) {
        .reservation-grid {
          grid-template-columns: minmax(260px, 1fr) minmax(260px, 1fr);
        }
      }

      .sticky-bar {
        display: none;
        position: fixed;
        left: var(--space-3);
        right: var(--space-3);
        bottom: calc(var(--bottom-nav-height) + var(--space-3) + env(safe-area-inset-bottom));
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 20px rgba(31, 36, 48, 0.2);
        padding: var(--space-3);
        gap: var(--space-3);
        align-items: stretch;
        justify-content: space-between;
        flex-direction: column;
        z-index: 20;
      }

      .sticky-bar.active {
        display: flex;
      }

      .sticky-info {
        font-size: 13px;
        color: #2f3745;
        font-weight: 600;
      }

      #sticky-action {
        width: 100%;
      }

      .mobile-tabs {
        display: flex;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
        background: var(--color-surface);
        border-top: 1px solid var(--color-border);
        padding: 8px 16px calc(env(safe-area-inset-bottom) + 4px);
        gap: var(--space-2);
        justify-content: space-around;
        z-index: 15;
      }

      .mobile-tab {
        border: 1px solid transparent;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: var(--color-muted);
        flex: 1;
        min-height: var(--tap-target);
        border-radius: var(--radius-md);
      }

      .mobile-tab.active {
        color: var(--color-primary);
        background: var(--color-primary-soft);
        border-color: rgba(var(--color-primary-rgb), 0.2);
      }

      @media (min-width: 900px) {
        .app {
          padding-bottom: var(--space-6);
        }

        .header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
        }

        .title {
          font-size: 28px;
        }

        .header-actions {
          width: auto;
        }

        .user-meta {
          max-width: none;
          white-space: normal;
        }

        .mode-tabs {
          display: flex;
          margin-left: auto;
        }

        .mobile-tabs {
          display: none;
        }

        .board {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .card-actions {
          display: flex;
          margin-top: var(--space-3);
        }

        .card-hint {
          display: none;
        }

        .info-row.secondary {
          display: grid;
        }

        .slot-row {
          grid-template-columns: 1fr auto;
        }

        .slot-row .btn {
          display: inline-flex;
        }

        .footer {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }

        .section-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .legend {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
      }

      .legend-item {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .legend-item.status-free {
        background: var(--status-free-bg);
        color: var(--status-free-text);
      }

      .legend-item.status-in_use {
        background: var(--status-in_use-bg);
        color: var(--status-in_use-text);
      }

      .legend-item.status-reserved {
        background: var(--status-reserved-bg);
        color: var(--status-reserved-text);
      }

      .legend-item.status-overdue {
        background: var(--status-overdue-bg);
        color: var(--status-overdue-text);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div class="title-group">
          <div class="title">ChargeMatter</div>
          <div class="subtitle">EV charger status board</div>
        </div>
        <nav class="mode-tabs" id="mode-tabs">
          <button class="mode-tab active" data-mode="now">Now</button>
          <button class="mode-tab" data-mode="reserve">Reserve</button>
        </nav>
        <div class="header-actions">
          <div class="user-meta" id="user-meta"></div>
          <button class="btn ghost" id="refresh-btn">Refresh</button>
        </div>
      </header>

      <section class="notice" id="notice" aria-live="polite"></section>

      <section class="mode mode-now active" id="mode-now">
        <div class="summary" id="summary"></div>
        <main class="board" id="board"></main>
      </section>

      <section class="mode mode-reserve" id="mode-reserve">
        <div class="section-header">
          <div>
            <div class="section-title">Next available slots</div>
            <div class="section-subtitle">Book the soonest open charger.</div>
          </div>
          <div class="section-meta" id="reservation-limits"></div>
        </div>
        <div class="edit-banner" id="edit-banner"></div>
        <div id="slots-list"></div>

        <div class="reservations">
          <div class="section-header">
            <div>
              <div class="section-title">My reservations</div>
              <div class="section-subtitle">Edit or cancel upcoming slots.</div>
            </div>
          </div>
          <div class="reservation-list">
            <div id="reservations-list"></div>
          </div>
        </div>
      </section>

      <footer class="footer">
        <div>Last updated: <span id="last-updated">--</span></div>
        <div class="legend">
          <span class="legend-item status-free">Free</span>
          <span class="legend-item status-in_use">In use</span>
          <span class="legend-item status-reserved">Reserved</span>
          <span class="legend-item status-overdue">Overdue</span>
        </div>
      </footer>
    </div>

    <div class="sticky-bar" id="sticky-bar" aria-live="polite">
      <div class="sticky-info" id="sticky-info">Select a charger or slot</div>
      <button class="btn" id="sticky-action" disabled>Action</button>
    </div>

    <nav class="mobile-tabs" id="mobile-tabs">
      <button class="mobile-tab active" data-mode="now">Now</button>
      <button class="mobile-tab" data-mode="reserve">Reserve</button>
    </nav>

    <script>
      window.APP_CONFIG = {
        userEmail: 'alex@graymatter-robotics.com',
        userName: 'Alex Rivera',
        isAdmin: true
      };

      (function initLocalApi() {
        const baseNow = () => new Date();
        const addMinutes = (base, minutes) => new Date(base.getTime() + minutes * 60000);
        const makeId = (prefix) => `${prefix}-${Math.random().toString(36).slice(2, 8)}`;
        const config = {
          reservationAdvanceDays: 7,
          reservationMaxUpcoming: 2,
          reservationMaxPerDay: 1,
          reservationCheckinEarlyMinutes: 5,
          reservationLateGraceMinutes: 10
        };

        const mockUserEmail = window.APP_CONFIG.userEmail;
        const now = baseNow();
        const reservationA = {
          reservationId: 'R-1001',
          chargerId: 'C3',
          startTime: addMinutes(now, 90).toISOString(),
          endTime: addMinutes(now, 150).toISOString(),
          status: 'active'
        };
        const reservationB = {
          reservationId: 'R-1002',
          chargerId: 'C1',
          startTime: addMinutes(now, 180).toISOString(),
          endTime: addMinutes(now, 240).toISOString(),
          status: 'active'
        };

        let reservations = [reservationA, reservationB];
        let chargers = [
          {
            id: 'C1',
            name: 'Charger 1',
            statusKey: 'free',
            status: 'Free',
            maxMinutes: 120,
            session: null,
            reservation: null
          },
          {
            id: 'C2',
            name: 'Charger 2',
            statusKey: 'in_use',
            status: 'In use',
            maxMinutes: 120,
            session: {
              sessionId: 'S-2001',
              userEmail: mockUserEmail,
              endTime: addMinutes(now, 45).toISOString()
            },
            reservation: null
          },
          {
            id: 'C3',
            name: 'Charger 3',
            statusKey: 'reserved',
            status: 'Reserved',
            maxMinutes: 60,
            session: null,
            reservation: reservationA
          },
          {
            id: 'C4',
            name: 'Charger 4',
            statusKey: 'overdue',
            status: 'Overdue',
            maxMinutes: 60,
            session: {
              sessionId: 'S-2002',
              userEmail: 'sam@graymatter-robotics.com',
              endTime: addMinutes(now, -20).toISOString()
            },
            reservation: null
          }
        ];

        const slots = [
          {
            chargerId: 'C1',
            startTime: addMinutes(now, 60).toISOString(),
            endTime: addMinutes(now, 120).toISOString()
          },
          {
            chargerId: 'C2',
            startTime: addMinutes(now, 140).toISOString(),
            endTime: addMinutes(now, 200).toISOString()
          },
          {
            chargerId: 'C3',
            startTime: addMinutes(now, 220).toISOString(),
            endTime: addMinutes(now, 280).toISOString()
          },
          {
            chargerId: 'C4',
            startTime: addMinutes(now, 1440).toISOString(),
            endTime: addMinutes(now, 1500).toISOString()
          }
        ];

        const findCharger = (id) => chargers.find((charger) => charger.id === id);
        const setFree = (charger) => {
          charger.statusKey = 'free';
          charger.status = 'Free';
          charger.session = null;
          charger.reservation = null;
        };
        const setInUse = (charger, session) => {
          charger.statusKey = 'in_use';
          charger.status = 'In use';
          charger.session = session;
          charger.reservation = null;
        };
        const setReserved = (charger, reservation) => {
          charger.statusKey = 'reserved';
          charger.status = 'Reserved';
          charger.session = null;
          charger.reservation = reservation;
        };

        const buildBoard = () => ({
          chargers: chargers.map((charger) => ({ ...charger })),
          reservations: reservations.map((reservation) => ({ ...reservation })),
          serverTime: new Date().toISOString(),
          config
        });

        const api = {
          getBoardData() {
            return buildBoard();
          },
          getAvailabilitySummary() {
            return slots.map((slot) => ({ ...slot }));
          },
          startSession(chargerId) {
            const charger = findCharger(chargerId);
            if (!charger) {
              throw new Error('Charger not found.');
            }
            const session = {
              sessionId: makeId('S'),
              userEmail: mockUserEmail,
              endTime: addMinutes(new Date(), 45).toISOString()
            };
            reservations = reservations.filter((reservation) => reservation.chargerId !== chargerId);
            setInUse(charger, session);
            return buildBoard();
          },
          endSession(sessionId) {
            const charger = chargers.find((item) => item.session?.sessionId === sessionId);
            if (charger) {
              setFree(charger);
            }
            return buildBoard();
          },
          notifyOwner() {
            return buildBoard();
          },
          createReservation(chargerId, startTime) {
            const newReservation = {
              reservationId: makeId('R'),
              chargerId,
              startTime,
              endTime: addMinutes(new Date(startTime), 60).toISOString(),
              status: 'active'
            };
            reservations.push(newReservation);
            const charger = findCharger(chargerId);
            if (charger && charger.statusKey === 'free') {
              setReserved(charger, newReservation);
            }
            return buildBoard();
          },
          updateReservation(reservationId, chargerId, startTime) {
            const reservation = reservations.find((item) => item.reservationId === reservationId);
            if (!reservation) {
              throw new Error('Reservation not found.');
            }
            const previousCharger = findCharger(reservation.chargerId);
            if (previousCharger?.reservation?.reservationId === reservationId) {
              setFree(previousCharger);
            }
            reservation.chargerId = chargerId;
            reservation.startTime = startTime;
            reservation.endTime = addMinutes(new Date(startTime), 60).toISOString();
            const nextCharger = findCharger(chargerId);
            if (nextCharger && nextCharger.statusKey === 'free') {
              setReserved(nextCharger, reservation);
            }
            return buildBoard();
          },
          cancelReservation(reservationId) {
            const reservation = reservations.find((item) => item.reservationId === reservationId);
            if (reservation) {
              const charger = findCharger(reservation.chargerId);
              if (charger?.reservation?.reservationId === reservationId) {
                setFree(charger);
              }
            }
            reservations = reservations.filter((item) => item.reservationId !== reservationId);
            return buildBoard();
          },
          checkInReservation(reservationId) {
            const reservation = reservations.find((item) => item.reservationId === reservationId);
            if (!reservation) {
              throw new Error('Reservation not found.');
            }
            reservations = reservations.filter((item) => item.reservationId !== reservationId);
            const charger = findCharger(reservation.chargerId);
            if (charger) {
              const session = {
                sessionId: makeId('S'),
                userEmail: mockUserEmail,
                endTime: addMinutes(new Date(), 45).toISOString()
              };
              setInUse(charger, session);
            }
            return buildBoard();
          },
          forceEnd(chargerId) {
            const charger = findCharger(chargerId);
            if (charger) {
              setFree(charger);
            }
            return buildBoard();
          },
          resetCharger(chargerId) {
            const charger = findCharger(chargerId);
            if (charger) {
              setFree(charger);
            }
            return buildBoard();
          }
        };

        function createRunner(apiMethods) {
          let successHandler = null;
          let failureHandler = null;
          const runner = {
            withSuccessHandler(handler) {
              successHandler = handler;
              return runner;
            },
            withFailureHandler(handler) {
              failureHandler = handler;
              return runner;
            }
          };
          Object.keys(apiMethods).forEach((method) => {
            runner[method] = (...args) => {
              try {
                const result = apiMethods[method](...args);
                if (successHandler) {
                  successHandler(result);
                }
              } catch (error) {
                if (failureHandler) {
                  failureHandler(error);
                } else {
                  throw error;
                }
              }
            };
          });
          return runner;
        }

        window.google = {
          script: {
            run: createRunner(api)
          }
        };
      })();
    </script>
    <script>
      const state = {
        board: null,
        reservations: [],
        serverTime: null,
        lastFetch: null,
        editingReservationId: null,
        mode: 'now',
        selectedCharger: null,
        selectedSlot: null,
        highlightReservationId: null
      };

      function init() {
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.addEventListener('click', loadBoard);
        setUserMeta();
        loadBoard();
        setInterval(updateCountdowns, 1000);
        setupModeTabs();
        setupGlobalHandlers();
        setMode('now');
      }

      function setUserMeta() {
        const meta = document.getElementById('user-meta');
        meta.textContent = `${APP_CONFIG.userName} (${APP_CONFIG.userEmail})`;
      }

      function setNotice(message) {
        const notice = document.getElementById('notice');
        notice.textContent = message || '';
        notice.classList.toggle('notice--active', Boolean(message));
      }

      function setLoading(isLoading) {
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.disabled = isLoading;
      }

      function loadBoard() {
        setNotice('');
        setLoading(true);
        google.script.run
          .withSuccessHandler((data) => {
            setLoading(false);
            renderBoard(data);
          })
          .withFailureHandler((err) => {
            setLoading(false);
            setNotice(err.message || String(err));
          })
          .getBoardData();
      }

      function renderBoard(data) {
        state.board = data;
        state.reservations = data.reservations || [];
        state.serverTime = new Date(data.serverTime);
        state.lastFetch = Date.now();
        const board = document.getElementById('board');
        board.innerHTML = '';
        renderSummary(data);

        if (!data.chargers.length) {
          const empty = document.createElement('div');
          empty.textContent = 'No chargers configured yet.';
          board.appendChild(empty);
          return;
        }

        data.chargers.forEach((charger) => {
          board.appendChild(createCard(charger));
        });

        updateReservationUI(data);
        loadSlots();
        updateStickyBar();
        updateSelectionUI();
        updateCountdowns();
      }

      function renderSummary(data) {
        const summary = document.getElementById('summary');
        if (!summary) {
          return;
        }
        if (!data?.chargers?.length) {
          summary.classList.add('is-hidden');
          summary.innerHTML = '';
          return;
        }
        summary.classList.remove('is-hidden');
        const counts = data.chargers.reduce(
          (acc, charger) => {
            acc[charger.statusKey] = (acc[charger.statusKey] || 0) + 1;
            return acc;
          },
          { free: 0, in_use: 0, reserved: 0, overdue: 0 }
        );
        summary.innerHTML = '';
        [
          { key: 'free', label: 'Free' },
          { key: 'in_use', label: 'In use' },
          { key: 'reserved', label: 'Reserved' },
          { key: 'overdue', label: 'Overdue' }
        ].forEach((item) => {
          const chip = document.createElement('div');
          chip.className = `summary-item status-${item.key}`;
          const count = document.createElement('strong');
          count.textContent = counts[item.key] || 0;
          const label = document.createElement('span');
          label.textContent = item.label;
          chip.appendChild(count);
          chip.appendChild(label);
          summary.appendChild(chip);
        });
      }

      function createCard(charger) {
        const card = document.createElement('div');
        card.className = `card status-${charger.statusKey}`;
        card.dataset.chargerId = charger.id;

        const header = document.createElement('div');
        header.className = 'card-header';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = charger.name;

        const headerRight = document.createElement('div');
        headerRight.className = 'card-header-right';

        const status = document.createElement('div');
        status.className = 'status-pill';
        status.textContent = charger.status;

        header.appendChild(title);
        headerRight.appendChild(status);

        if (APP_CONFIG.isAdmin) {
          const menu = document.createElement('div');
          menu.className = 'menu';
          const trigger = document.createElement('button');
          trigger.className = 'menu-trigger';
          trigger.type = 'button';
          trigger.textContent = '⋯';
          const list = document.createElement('div');
          list.className = 'menu-list';
          const forceBtn = document.createElement('button');
          forceBtn.className = 'menu-item';
          forceBtn.textContent = 'Force end';
          forceBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (confirm('Force end this session?')) {
              callServer('forceEnd', [charger.id]);
            }
            list.classList.remove('active');
          });
          const resetBtn = document.createElement('button');
          resetBtn.className = 'menu-item';
          resetBtn.textContent = 'Reset charger';
          resetBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (confirm('Reset this charger?')) {
              callServer('resetCharger', [charger.id]);
            }
            list.classList.remove('active');
          });
          list.appendChild(forceBtn);
          list.appendChild(resetBtn);
          trigger.addEventListener('click', (event) => {
            event.stopPropagation();
            closeAllMenus();
            list.classList.toggle('active');
          });
          menu.appendChild(trigger);
          menu.appendChild(list);
          headerRight.appendChild(menu);
        }

        header.appendChild(headerRight);

        const body = document.createElement('div');
        body.className = 'card-body';

        if (charger.session) {
          body.appendChild(createInfoRow('Max time', formatDuration(charger.maxMinutes), { secondary: true }));
          body.appendChild(createInfoRow('Ends at', formatTime(charger.session.endTime)));
          const countdown = createInfoRow('Countdown', '--');
          countdown.querySelector('.value').classList.add('countdown');
          countdown.querySelector('.value').dataset.endTime = charger.session.endTime;
          body.appendChild(countdown);
        } else if (charger.reservation) {
          body.appendChild(createInfoRow('Max time', formatDuration(charger.maxMinutes), { secondary: true }));
          body.appendChild(createInfoRow('Reserved at', formatTime(charger.reservation.startTime)));
        } else {
          body.appendChild(createInfoRow('Max time', formatDuration(charger.maxMinutes), { secondary: true }));
          body.appendChild(createInfoRow('Status', 'Available now'));
        }

        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const primary = getPrimaryAction(charger);
        const primaryBtn = createButton(primary.label, 'btn primary-action', () => {
          selectCharger(charger);
          primary.action();
        });
        actions.appendChild(primaryBtn);

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(actions);
        const hint = document.createElement('div');
        hint.className = 'card-hint';
        hint.textContent = 'Tap to select';
        card.appendChild(hint);
        card.addEventListener('click', (event) => {
          if (event.target.closest('button')) {
            return;
          }
          selectCharger(charger);
        });
        return card;
      }

      function createInfoRow(label, value, options = {}) {
        const row = document.createElement('div');
        row.className = 'info-row';
        if (options.secondary) {
          row.classList.add('secondary');
        }
        const labelSpan = document.createElement('span');
        labelSpan.className = 'label';
        labelSpan.textContent = label;
        const valueSpan = document.createElement('span');
        valueSpan.className = 'value';
        valueSpan.textContent = value || '--';
        row.appendChild(labelSpan);
        row.appendChild(valueSpan);
        return row;
      }

      function createButton(text, className, onClick) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        button.addEventListener('click', onClick);
        return button;
      }

      function slotKey(slot) {
        return encodeURIComponent(`${slot.chargerId}::${slot.startTime}`);
      }

      function updateSelectionUI() {
        document.querySelectorAll('.card.selected').forEach((card) => card.classList.remove('selected'));
        document.querySelectorAll('.slot-row.selected').forEach((row) => row.classList.remove('selected'));
        if (state.selectedCharger) {
          const card = document.querySelector(`.card[data-charger-id="${state.selectedCharger.id}"]`);
          if (card) {
            card.classList.add('selected');
          }
        }
        if (state.selectedSlot) {
          const key = slotKey(state.selectedSlot);
          const row = document.querySelector(`.slot-row[data-slot-key="${key}"]`);
          if (row) {
            row.classList.add('selected');
          }
        }
      }

      function callServer(method, args) {
        setNotice('');
        setLoading(true);
        const runner = google.script.run
          .withSuccessHandler((data) => {
            setLoading(false);
            renderBoard(data);
          })
          .withFailureHandler((err) => {
            setLoading(false);
            setNotice(err.message || String(err));
          });
        runner[method].apply(runner, args);
      }

      function updateReservationUI(data) {
        renderReservationsList(state.reservations || []);
        renderReservationLimits(data.config || {});
        renderEditBanner();
      }

      function renderReservationLimits(config) {
        const meta = document.getElementById('reservation-limits');
        const parts = [];
        if (config.reservationAdvanceDays) {
          parts.push(`Up to ${config.reservationAdvanceDays} days ahead`);
        }
        if (config.reservationMaxUpcoming) {
          parts.push(`Max ${config.reservationMaxUpcoming} upcoming`);
        }
        if (config.reservationMaxPerDay) {
          parts.push(`Max ${config.reservationMaxPerDay} per day`);
        }
        meta.textContent = parts.join(' · ');
      }

      function renderReservationsList(reservations) {
        const list = document.getElementById('reservations-list');
        list.innerHTML = '';
        if (!reservations.length) {
          const empty = document.createElement('div');
          empty.textContent = 'No upcoming reservations yet.';
          list.appendChild(empty);
          return;
        }
        reservations.forEach((reservation) => {
          const item = document.createElement('div');
          item.className = 'reservation-item';
          if (state.highlightReservationId === reservation.reservationId) {
            item.classList.add('highlight');
          }
          const title = document.createElement('strong');
          title.textContent = reservationLabel(reservation);
          item.appendChild(title);
          item.appendChild(createInfoRow('Start', formatTime(reservation.startTime)));
          item.appendChild(createInfoRow('End', formatTime(reservation.endTime)));
          const status = reservation.status ? reservation.status.replace(/_/g, ' ') : 'active';
          item.appendChild(createInfoRow('Status', status));
          const actions = document.createElement('div');
          actions.className = 'reservation-actions';
          const editBtn = createButton('Change', 'btn ghost', () => startReservationEdit(reservation));
          const cancelBtn = createButton('Cancel', 'btn warn', () => {
            if (confirm('Cancel this reservation?')) {
              callServer('cancelReservation', [reservation.reservationId]);
            }
          });
          actions.appendChild(editBtn);
          actions.appendChild(cancelBtn);
          if (shouldShowCheckIn(reservation)) {
            const checkInBtn = createButton('Check in', 'btn secondary', () => {
              callServer('checkInReservation', [reservation.reservationId]);
            });
            actions.appendChild(checkInBtn);
          }
          item.appendChild(actions);
          list.appendChild(item);
        });
      }

      function reservationLabel(reservation) {
        const charger = state.board?.chargers?.find((item) => item.id === reservation.chargerId);
        return charger ? charger.name : `Charger ${reservation.chargerId}`;
      }

      function startReservationEdit(reservation) {
        state.editingReservationId = reservation.reservationId;
        setMode('reserve');
        renderEditBanner();
        setNotice('Select a new slot to replace this reservation.');
      }

      function cancelReservationEdit() {
        state.editingReservationId = null;
        renderEditBanner();
        setNotice('');
      }

      function updateCountdowns() {
        if (!state.serverTime || !state.lastFetch) {
          return;
        }
        const now = new Date(state.serverTime.getTime() + (Date.now() - state.lastFetch));
        document.getElementById('last-updated').textContent = now.toLocaleTimeString([], {
          hour: 'numeric',
          minute: '2-digit'
        });
        document.querySelectorAll('.countdown').forEach((el) => {
          const endTime = new Date(el.dataset.endTime);
          if (Number.isNaN(endTime.getTime())) {
            return;
          }
          const diffMs = endTime.getTime() - now.getTime();
          if (diffMs >= 0) {
            const mins = Math.floor(diffMs / 60000);
            const secs = Math.floor((diffMs % 60000) / 1000);
            el.textContent = formatCountdown(mins, secs);
          } else {
            const overdueMinutes = Math.max(1, Math.ceil(Math.abs(diffMs) / 60000));
            el.textContent = `Overdue by ${overdueMinutes}m`;
          }
        });
      }

      function formatCountdown(minutes, seconds) {
        const hours = Math.floor(minutes / 60);
        const remaining = minutes % 60;
        if (hours > 0) {
          return `${hours}h ${pad(remaining)}m`;
        }
        return `${remaining}m ${pad(seconds)}s`;
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) {
          return '--';
        }
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      }

      function formatDuration(minutes) {
        if (!minutes) {
          return '--';
        }
        if (minutes < 60) {
          return `${minutes} minutes`;
        }
        const hours = minutes / 60;
        if (Number.isInteger(hours)) {
          return `${hours} hours`;
        }
        return `${hours.toFixed(1)} hours`;
      }

      function pad(value) {
        return String(value).padStart(2, '0');
      }

      function formatDateInput(date) {
        if (Number.isNaN(date.getTime())) {
          return '';
        }
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        return `${year}-${month}-${day}`;
      }

      function formatTimeInput(date) {
        if (Number.isNaN(date.getTime())) {
          return '';
        }
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${hours}:${minutes}`;
      }

      function shouldShowCheckIn(reservation) {
        if (!reservation.startTime || reservation.status === 'no_show' || reservation.status === 'canceled') {
          return false;
        }
        const config = state.board?.config || {};
        const earlyMinutes = config.reservationCheckinEarlyMinutes || 5;
        const graceMinutes = config.reservationLateGraceMinutes || 10;
        const start = new Date(reservation.startTime);
        const now = getClientNow();
        const earliest = new Date(start.getTime() - earlyMinutes * 60000);
        const latest = new Date(start.getTime() + graceMinutes * 60000);
        if (Number.isNaN(start.getTime())) {
          return false;
        }
        return now >= earliest && now <= latest;
      }

      function getClientNow() {
        if (!state.serverTime || !state.lastFetch) {
          return new Date();
        }
        return new Date(state.serverTime.getTime() + (Date.now() - state.lastFetch));
      }

      function setupModeTabs() {
        document.querySelectorAll('.mode-tab, .mobile-tab').forEach((btn) => {
          btn.addEventListener('click', () => {
            setMode(btn.dataset.mode);
          });
        });
      }

      function setupGlobalHandlers() {
        document.addEventListener('click', () => closeAllMenus());
        window.addEventListener('resize', () => updateStickyBar());
      }

      function setMode(mode) {
        state.mode = mode;
        document.querySelectorAll('.mode-tab').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        document.querySelectorAll('.mobile-tab').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        document.getElementById('mode-now').classList.toggle('active', mode === 'now');
        document.getElementById('mode-reserve').classList.toggle('active', mode === 'reserve');
        clearSelection();
        updateStickyBar();
      }

      function closeAllMenus() {
        document.querySelectorAll('.menu-list.active').forEach((menu) => menu.classList.remove('active'));
      }

      function getPrimaryAction(charger) {
        if (charger.session) {
          if (charger.session.userEmail === APP_CONFIG.userEmail) {
            return {
              label: 'End session',
              action: () => callServer('endSession', [charger.session.sessionId])
            };
          }
          return {
            label: 'Notify owner',
            action: () => callServer('notifyOwner', [charger.id])
          };
        }
        if (charger.statusKey === 'overdue') {
          return {
            label: 'Notify owner',
            action: () => callServer('notifyOwner', [charger.id])
          };
        }
        if (charger.statusKey === 'reserved') {
          return {
            label: 'View reservation',
            action: () => viewReservation(charger)
          };
        }
        return {
          label: 'Start charging',
          action: () => callServer('startSession', [charger.id])
        };
      }

      function viewReservation(charger) {
        setMode('reserve');
        if (charger.reservation) {
          state.highlightReservationId = charger.reservation.reservationId;
          renderReservationsList(state.reservations || []);
        }
        document.getElementById('reservations-list').scrollIntoView({ behavior: 'smooth' });
      }

      function selectCharger(charger) {
        state.selectedCharger = charger;
        state.selectedSlot = null;
        updateSelectionUI();
        updateStickyBar();
      }

      function selectSlot(slot) {
        state.selectedSlot = slot;
        state.selectedCharger = null;
        updateSelectionUI();
        updateStickyBar();
      }

      function clearSelection() {
        state.selectedCharger = null;
        state.selectedSlot = null;
        updateSelectionUI();
        updateStickyBar();
      }

      function updateStickyBar() {
        const bar = document.getElementById('sticky-bar');
        const info = document.getElementById('sticky-info');
        const actionBtn = document.getElementById('sticky-action');
        if (window.innerWidth >= 900) {
          bar.classList.remove('active');
          return;
        }
        actionBtn.disabled = true;
        actionBtn.onclick = null;
        if (state.mode === 'now' && state.selectedCharger) {
          const primary = getPrimaryAction(state.selectedCharger);
          info.textContent = `${state.selectedCharger.name} selected`;
          actionBtn.textContent = primary.label;
          actionBtn.disabled = false;
          actionBtn.onclick = () => primary.action();
          bar.classList.add('active');
          return;
        }
        if (state.mode === 'reserve' && state.selectedSlot) {
          const label = `${formatTime(state.selectedSlot.startTime)} · ${reservationLabel({
            chargerId: state.selectedSlot.chargerId
          })}`;
          info.textContent = label;
          actionBtn.textContent = state.editingReservationId ? 'Update reservation' : 'Book slot';
          actionBtn.disabled = false;
          actionBtn.onclick = () => bookSlot(state.selectedSlot);
          bar.classList.add('active');
          return;
        }
        bar.classList.remove('active');
      }

      function loadSlots() {
        google.script.run
          .withSuccessHandler((slots) => {
            renderSlotsList(slots || []);
          })
          .withFailureHandler((err) => {
            setNotice(err.message || String(err));
          })
          .getAvailabilitySummary();
      }

      function renderSlotsList(slots) {
        const container = document.getElementById('slots-list');
        container.innerHTML = '';
        if (!slots.length) {
          const empty = document.createElement('div');
          empty.textContent = 'No available slots found.';
          container.appendChild(empty);
          return;
        }
        const groups = groupSlotsByDay(slots);
        groups.forEach((group) => {
          const groupEl = document.createElement('div');
          groupEl.className = 'slots-group';
          const title = document.createElement('div');
          title.className = 'slots-group-title';
          title.textContent = group.label;
          groupEl.appendChild(title);
          group.slots.forEach((slot) => {
            const row = document.createElement('div');
            row.className = 'slot-row';
            row.dataset.slotKey = slotKey(slot);
            row.addEventListener('click', () => selectSlot(slot));
            const meta = document.createElement('div');
            meta.className = 'slot-meta';
            meta.innerHTML = `<div>${formatTime(slot.startTime)} – ${formatTime(slot.endTime)}</div><div>${reservationLabel({
              chargerId: slot.chargerId
            })}</div>`;
            const action = createButton('Book', 'btn', (event) => {
              event.stopPropagation();
              bookSlot(slot);
            });
            row.appendChild(meta);
            row.appendChild(action);
            groupEl.appendChild(row);
          });
          container.appendChild(groupEl);
        });
        updateSelectionUI();
      }

      function groupSlotsByDay(slots) {
        const grouped = {};
        slots.forEach((slot) => {
          const dateKey = formatDateInput(new Date(slot.startTime));
          if (!grouped[dateKey]) {
            grouped[dateKey] = [];
          }
          grouped[dateKey].push(slot);
        });
        return Object.keys(grouped)
          .sort()
          .map((dateKey) => ({
            label: formatDayLabel(new Date(`${dateKey}T00:00:00`)),
            slots: grouped[dateKey]
          }));
      }

      function formatDayLabel(date) {
        const now = getClientNow();
        const today = formatDateInput(now);
        const tomorrow = formatDateInput(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1));
        const dateKey = formatDateInput(date);
        if (dateKey === today) {
          return 'Today';
        }
        if (dateKey === tomorrow) {
          return 'Tomorrow';
        }
        return date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
      }

      function bookSlot(slot) {
        if (state.editingReservationId) {
          callServer('updateReservation', [state.editingReservationId, slot.chargerId, slot.startTime]);
        } else {
          callServer('createReservation', [slot.chargerId, slot.startTime]);
        }
        cancelReservationEdit();
        clearSelection();
      }

      function renderEditBanner() {
        const banner = document.getElementById('edit-banner');
        if (!banner) {
          return;
        }
        banner.innerHTML = '';
        if (!state.editingReservationId) {
          banner.classList.remove('active');
          return;
        }
        banner.classList.add('active');
        const text = document.createElement('div');
        text.textContent = 'Changing a reservation. Pick a new slot below.';
        const cancel = createButton('Cancel change', 'btn ghost', () => cancelReservationEdit());
        banner.appendChild(text);
        banner.appendChild(cancel);
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
